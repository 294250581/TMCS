//==============================================================================
//C文件
//与硬件无关的常用库函数
#include "utZLG7289.h"

//==============================================================================
//内部符号预定义

//==============================================================================
//内部调用变量

//==============================================================================
//内部调用函数定义

//==============================================================================
//外部调用函数

//==============================================================================
//外部调用函数


//##############################################################################
//模块
//##############################################################################
//------------------------------------------------------------------------------
void ZLG7289_SPI_Write(INT8U dat)
{  
	INT8U i;
    	
    for(i=0;i<8;i++)
	{
	  if (( dat & 0x80) != 0)       //send the high bit first,must has the ()!!!   
	       ZLG7289DAT(1);
      else
	       ZLG7289DAT(0);

	  dat=dat<<1;
		
	  Delay_1us(2);					//2us时间数据稳定
	  
	  ZLG7289CLK(1);
	  Delay_1us(8);					//T2: CLK高电平宽度
	  
	  ZLG7289CLK(0);
	  Delay_1us(8);					//T3: CLK低电平宽度
	}
}

INT8U ZLG7289_SPI_Read()
{
    INT8U t;
    INT8U DAT=0;
	
	SetZLG7289IN(1);		//配置为输入
	
    t = 8;
	do
	{
	    ZLG7289CLK(1);
	    Delay_1us(16);		//2*T6读数据
	    DAT<<=1;  
	    if(IsZLG7289DAT()) 
			DAT++;			//T7: CLK 8us已够
	    ZLG7289CLK(0);
	    Delay_1us(8);		//T3: CLK低电平8us

	} while ( --t != 0 );

	//T8: 8us已满足

	SetZLG7289IN(0);;		//回到输出
	
	return DAT;
}

void ZLG7289_cmd(char cmd)
{
 	ZLG7289CS(0);
	Delay_1us(200);
	ZLG7289_SPI_Write(cmd);
	ZLG7289CS(1);
	Delay_1us(50);
}

void ZLG7289_cmd_dat(char cmd, char dat)
{
	ZLG7289CS(0);
	Delay_1us(50);					//T1=50us
	ZLG7289_SPI_Write(cmd);
	Delay_1us(25);					//T4=25us，指令数据间隔
	ZLG7289_SPI_Write(dat);
	ZLG7289CS(1);
	Delay_1us(10);					//跟下一个指令间隔
}

INT8U ZLG7289_Key(void)
{
   INT8U key;
   
   ZLG7289CS(0);
   Delay_1us(50);				//T1=50us
   ZLG7289_SPI_Write(0x15);
   Delay_1us(25);  				//T5:指令到数据
   key=ZLG7289_SPI_Read();
   ZLG7289CS(1);
   Delay_1us(10);				//跟下一条指令间隔

   return key;
}

//##############################################################################

//==============================================================================
//内部调用函数

//==============================================================================
//end of the file


//------------------------------------------------------------------------------  




